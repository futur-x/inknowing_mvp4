# Thomas开发笔记 - WebSocket无限循环修复

## 问题概述
用户报告WebSocket重连导致的无限循环问题，错误信息："Maximum update depth exceeded"。组件重新挂载时会触发无限重连。

## Todo List
- [ ] 分析WebSocket连接和重连逻辑的根本原因
- [ ] 检查useEffect依赖数组问题
- [ ] 实现防重入机制
- [ ] 添加指数退避重连策略
- [ ] 确保组件卸载时正确清理
- [ ] 实施连接状态管理优化
- [ ] 使用Playwright进行端到端测试
- [ ] 验证修复效果

## 当前进度
✅ 完成分析WebSocket连接和重连逻辑的根本原因
✅ 完成检查useEffect依赖数组问题并修复
✅ 完成防重入机制实现
✅ 完成指数退避重连策略
✅ 完成组件卸载时的正确清理
✅ 完成连接状态管理优化
✅ 完成Playwright端到端测试
⏳ 正在验证修复效果

### 已完成的修复：
1. 简化useEffect依赖数组，只监控必要的值
2. 拆分连接和状态监控为两个独立的useEffect
3. 添加isConnectingRef防重入机制
4. 实现指数退避算法计算重连延迟
5. 修复WebSocket管理器的自动连接问题
6. 添加连接状态检查防止重复连接
7. 优化cleanup函数确保正确清理

## 业务逻辑对照
根据三图一端文档，WebSocket连接应该：
1. 建立持久连接用于实时消息传输
2. 支持自动重连但需要合理的退避策略
3. 组件卸载时必须清理连接

## 发现的问题/风险
- useEffect依赖数组可能导致无限循环
- 重连逻辑没有正确的防重入机制
- 状态更新可能触发不必要的重连

## 与三图一端的一致性检查
待完成

## 下一步计划
1. 深入分析useChat.tsx中的useEffect依赖
2. 检查WebSocket管理器实现

## 技术决策记录
- 需要实现指数退避算法
- 使用useRef存储连接状态避免闭包问题
- 添加连接锁防止并发连接