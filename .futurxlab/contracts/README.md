# InKnowing MVP 4.0 - Development Contracts

## 契约驱动开发（Contract-Driven Development, CDD）

这是 InKnowing 项目的开发验证契约集合，用于确保整个系统的一致性、可靠性和可维护性。

## 📋 契约文件列表

| 契约文件 | 描述 | 版本 |
|---------|------|------|
| `system.architecture.contract.yaml` | 系统整体架构契约，定义技术栈、服务架构、部署架构等 | 1.0.0 |
| `frontend.contract.yaml` | 前端功能契约，定义路由、状态管理、API调用、UI组件等 | 1.0.0 |
| `backend.api.contract.yaml` | 后端API契约，定义所有API端点、请求响应格式、认证授权等 | 1.0.0 |
| `data.model.contract.yaml` | 数据模型契约，定义数据库表结构、关系、索引、缓存策略等 | 1.0.0 |
| `integration.test.contract.yaml` | 集成测试契约，定义测试场景、测试流程、断言规则等 | 1.0.0 |
| `performance.security.contract.yaml` | 性能与安全契约，定义性能指标、安全要求、监控告警等 | 1.0.0 |

## 🚀 快速开始

### 1. 安装验证器依赖

```bash
cd .futurxlab/contracts
npm install
```

### 2. 运行契约验证

```bash
# 在项目根目录运行
npm run validate

# 或直接运行验证器
node .futurxlab/contracts/validate.js
```

### 3. 查看验证结果

验证器会输出：
- ✅ **通过的检查**：符合契约要求
- ❌ **违规项**：必须修复的问题
- ⚠️ **警告**：建议优化的问题

## 📖 契约使用指南

### 开发前 - 读取契约

```bash
# 查看特定契约
cat .futurxlab/contracts/frontend.contract.yaml

# 查看API端点契约
cat .futurxlab/contracts/backend.api.contract.yaml | grep -A 10 "login:"
```

### 开发中 - 遵循契约

开发时必须严格遵循契约中定义的：

1. **命名规范**
   - Cookie名称：`access_token`, `refresh_token`
   - API路径：`/v1/auth/login`, `/v1/users/profile`
   - WebSocket路径：`/ws/dialogue/{session_id}`

2. **数据格式**
   - 请求体格式
   - 响应体格式
   - 错误码规范

3. **路由配置**
   - 公开路由
   - 需认证路由
   - 管理员路由

### 开发后 - 验证契约

```bash
# 运行完整验证
node .futurxlab/contracts/validate.js

# 验证特定部分
node .futurxlab/contracts/validate.js --frontend
node .futurxlab/contracts/validate.js --backend
node .futurxlab/contracts/validate.js --integration
```

## 🔍 契约验证规则

### 严重等级

| 级别 | 标记 | 说明 | 处理要求 |
|------|-----|------|---------|
| ERROR | ❌ | 违反核心契约 | 必须立即修复 |
| WARNING | ⚠️ | 不符合最佳实践 | 建议优化 |
| INFO | ℹ️ | 提示信息 | 可选处理 |

### 主要验证规则

#### 前端验证规则
- `ROUTE001`: 所有受保护路由必须检查认证
- `AUTH001`: Cookie名称必须为 `access_token`
- `API001`: 所有API调用必须包含凭证
- `STATE001`: 认证状态必须与Cookie同步

#### 后端验证规则
- `SEC001`: 密码必须使用bcrypt加密
- `SEC002`: JWT令牌必须设置过期时间
- `API003`: 所有端点必须返回标准响应格式
- `DATA001`: UUID必须是有效的版本4

#### 集成验证规则
- `INT001`: 前后端Cookie名称必须一致
- `INT002`: API基础URL必须匹配
- `WS001`: WebSocket URL必须正确配置

## 🛠️ 契约维护

### 更新契约

1. 修改对应的 `.contract.yaml` 文件
2. 更新版本号
3. 运行验证确保兼容性
4. 提交更改

### 添加新规则

在 `validate.js` 中添加新的验证规则：

```javascript
// 添加新的验证规则
static validateNewRule(contract) {
  // 验证逻辑
  if (violation) {
    CONFIG.violations.push({
      file: 'filename',
      line: lineNumber,
      rule: 'RULE_ID',
      message: 'Description',
      severity: 'ERROR'
    });
  }
}
```

## 📊 契约覆盖范围

### 已覆盖
- ✅ 系统架构
- ✅ 前端路由和状态
- ✅ 后端API端点
- ✅ 数据模型
- ✅ 集成测试场景
- ✅ 性能指标
- ✅ 安全要求

### 待补充
- ⏳ 国际化（i18n）
- ⏳ 无障碍访问（a11y）
- ⏳ SEO优化
- ⏳ 监控指标

## 🤝 贡献指南

### 提交契约更改

1. 创建分支：`git checkout -b contract/update-xxx`
2. 修改契约文件
3. 运行验证：`npm run validate`
4. 提交PR并说明更改原因

### 报告问题

如果发现契约与实际代码不符，请：
1. 运行验证器确认问题
2. 创建Issue说明问题
3. 提供复现步骤

## 📚 参考文档

- [API架构图](./../api-architecture-diagram.md)
- [API规范](./../api-specification.yaml)
- [系统序列图](./../sequence-diagram.md)
- [状态图](./../state-diagram.md)
- [用户旅程图](./../user-journey-diagram.md)

## 📝 版本历史

### v1.0.0 (2025-09-21)
- 初始版本
- 包含6个核心契约文件
- 实现基础验证器

---

**Contract-Driven Development (CDD)** - 契约即宪法，验证即执法

通过契约驱动开发，我们确保：
- 🔄 前后端接口一致性
- 🛡️ 安全标准严格执行
- 📈 性能指标持续监控
- ✅ 质量标准自动验证

*Generated by Futurx-Contract-Developer-William*